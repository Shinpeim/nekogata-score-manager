# 2025-06-14 Input Focus Issue Fix

## 概要

コード編集画面でinput入力中にフォーカスが外れる重大なユーザビリティ問題を修正しました。この問題はReactのkey属性に変動する値が含まれていたことが原因でした。

## 問題の詳細

### 発生していた問題
- コード編集画面でコード名や拍数を入力中に、inputフィールドからフォーカスが外れる
- 入力が中断され、ユーザーは何度もクリックしてフォーカスを戻す必要があった
- 特に長いコード名や連続した編集作業で顕著に問題が発生

### 影響範囲
- ChordChartEditorコンポーネントのSortableChordItem
- 全てのコード名入力フィールド
- 全ての拍数入力フィールド
- ユーザビリティの大幅な低下

## 原因分析

### 技術的原因
React のkey属性に変動する値が含まれていたため、state変更のたびにコンポーネントが再作成されていました。

```typescript
// 問題のあったkey属性
key={`${section.id}-${chord.name}-${chordIndex}-${chord.duration || 4}`}
```

### 問題の流れ
1. ユーザーがinputフィールドでコード名を入力
2. `chord.name`が変更される
3. key属性が変わるため、Reactがコンポーネントを削除して再作成
4. 新しいコンポーネントにはフォーカスがない
5. ユーザーの入力が中断される

## 解決方法

### 修正内容
key属性から変動する値（`chord.name`、`chord.duration`）を削除し、安定した値のみを使用するように変更しました。

```typescript
// Before: 変動する値を含むkey（問題あり）
key={`${section.id}-${chord.name}-${chordIndex}-${chord.duration || 4}`}

// After: 安定したkeyのみ（修正後）
key={`${section.id}-${chordIndex}`}
```

### 修正箇所
**ファイル**: `src/components/ChordChartEditor.tsx`
**行**: 476行目

```typescript
// 修正前
<SortableChordItem
  key={`${section.id}-${chord.name}-${chordIndex}-${chord.duration || 4}`}
  // ...other props
/>

// 修正後
<SortableChordItem
  key={`${section.id}-${chordIndex}`}
  // ...other props
/>
```

## 技術的考慮事項

### Reactのkey属性の役割
- Reactは仮想DOMの差分計算でkey属性を使用してコンポーネントを識別
- keyが変わると、Reactは既存のコンポーネントを削除して新しいコンポーネントを作成
- このため、keyには安定した一意の値を使用する必要がある

### 適切なkey設計原則
1. **一意性**: 同じリスト内で重複しない
2. **安定性**: 内容が変わってもkeyは変わらない
3. **永続性**: 並び順が変わってもkeyは維持される

### 今回の修正における考慮
- `section.id`: セクションごとの一意性を保証
- `chordIndex`: セクション内でのコードの位置を示す
- これらの組み合わせで一意性と安定性を両立

## ドラッグ&ドロップへの影響

### 懸念事項
key属性の変更がドラッグ&ドロップ機能に影響を与える可能性がありました。

### 検証結果
- ドラッグ&ドロップは`itemId`プロパティを使用（`${section.id}-${chordIndex}`）
- key属性と同じ形式のため、機能に影響なし
- 既存のテストも全て通過

## パフォーマンス向上効果

### レンダリング最適化
- 不要なコンポーネント再作成が削減
- DOMの再構築回数が大幅に減少
- 入力時のパフォーマンスが向上

### メモリ使用量改善
- コンポーネントの破棄・作成サイクルが減少
- メモリリークのリスクが軽減

## ユーザビリティの改善

### Before（修正前）
```
ユーザー: 「Cmaj7」と入力しようとする
1. 「C」を入力 → フォーカス外れる
2. クリックしてフォーカス戻す
3. 「m」を入力 → またフォーカス外れる
4. 再度クリック...
結果: 非常にストレスフルな編集体験
```

### After（修正後）
```
ユーザー: 「Cmaj7」と入力しようとする
1. 「Cmaj7」を一気に入力できる
2. フォーカスが維持される
結果: スムーズな編集体験
```

## テスト戦略

### 手動テスト項目
- [x] コード名入力時のフォーカス維持確認
- [x] 拍数入力時のフォーカス維持確認
- [x] 連続編集時の動作確認
- [x] ドラッグ&ドロップ機能の動作確認

### 自動テスト
既存のテストスイートが全て通過することを確認：
- ChordChartEditorのテスト
- ドラッグ&ドロップ関連のテスト
- 各種レンダリングテスト

## 今後の予防策

### コードレビューでの注意点
1. React key属性には安定した値のみを使用
2. コンポーネントのstate値をkeyに含めない
3. ユーザー入力値をkeyに含めない

### 設計原則
- key属性は「コンポーネントの身分証明書」として扱う
- 内容が変わっても身分証明書は変わらない設計にする
- リスト操作（追加・削除・並び替え）でのみkey変更を許可

## 結果

### 機能面の成果
- ✅ input入力時のフォーカス維持
- ✅ スムーズな編集体験の実現
- ✅ ユーザビリティの大幅向上
- ✅ 既存機能への影響なし

### 技術面の成果
- ✅ 適切なReact key設計の実装
- ✅ パフォーマンス最適化
- ✅ メンテナビリティの向上
- ✅ 将来の同様問題の予防

### ユーザー体験の改善
- ✅ 中断のない入力体験
- ✅ 編集効率の大幅向上
- ✅ ストレスフリーなワークフロー
- ✅ プロフェッショナルな操作感

この修正により、Nekogata Score Managerのコード編集機能が大幅に改善され、ユーザーは快適にコード譜を編集できるようになりました。