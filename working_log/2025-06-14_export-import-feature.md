# コード譜エクスポート・インポート機能の実装

## 作業日時
2025-06-14

## 対応内容

### 要求・目標
楽譜をポータブルにして、エクスポート・インポートできるようにする機能の実装

### 実装した機能

#### 1. JSONエクスポート機能
- **単一コード譜のエクスポート**: 現在表示中のコード譜を個別にJSONファイルとして保存
- **複数選択エクスポート**: チェックボックスで選択した複数のコード譜をまとめてエクスポート
- **全楽譜一括エクスポート**: ライブラリ内のすべてのコード譜を一度にエクスポート
- **ファイル名の自動生成**: 楽譜タイトルや日付を基にした適切なファイル名の生成
- **ファイル名サニタイズ**: 不正文字の除去と長さ制限

#### 2. JSONインポート機能
- **ファイル選択インターフェース**: ドラッグ&ドロップ対応のファイル選択
- **複数フォーマット対応**: 
  - 新しいエクスポート形式（メタデータ付き）
  - 旧形式のコード譜配列
  - 単一コード譜オブジェクト
- **データバリデーション**: 必須フィールドのチェックと自動修正
- **エラーハンドリング**: 詳細なエラーメッセージと警告表示

#### 3. データ移行・修正機能
- **拍子対応**: インポート時に拍子と拍数の整合性を自動修正
- **ID重複回避**: インポート時に新しいIDを自動生成
- **日付フィールド修正**: 不正な日付データの自動修正
- **セクション補完**: 不足しているセクションプロパティの自動補完

#### 4. ユーザーインターフェース
- **エクスポート・インポートダイアログ**: タブ切り替え可能な統合UI
- **リアルタイムフィードバック**: インポート進行状況とエラー表示
- **楽譜選択機能**: チェックボックスによる複数選択とまとめて操作
- **結果表示**: インポート結果の詳細表示（成功数、警告、エラー）

### 技術的詳細

#### 実装されたファイル
- `src/utils/exportImport.ts`: エクスポート・インポートのコア機能
- `src/components/ExportImportDialog.tsx`: UI コンポーネント
- `src/components/ChordChart.tsx`: エクスポート・インポート機能の統合
- `src/utils/__tests__/exportImport.test.ts`: 包括的テストスイート（14テスト）

#### データフォーマット
```typescript
interface ExportData {
  version: string;           // アプリケーションバージョン
  exportDate: string;        // エクスポート日時
  charts: ChordChart[];      // コード譜データ配列
}
```

#### エクスポート機能
- `exportSingleChart()`: 単一コード譜のエクスポート
- `exportMultipleCharts()`: 複数コード譜のエクスポート
- `exportAllCharts()`: 全楽譜のエクスポート

#### インポート機能
- `importChartsFromFile()`: ファイルからのインポート
- `parseImportData()`: JSONデータの解析と検証
- `validateChartArray()`: コード譜配列の検証
- `validateSingleChart()`: 単一コード譜の検証
- `migrateChartData()`: データ移行処理

### UI/UX設計

#### エクスポートタブ
1. **現在のコード譜**: ワンクリックでエクスポート
2. **選択したコード譜**: チェックボックスで選択、まとめてエクスポート
3. **すべてのコード譜**: 全データの一括エクスポート

#### インポートタブ
1. **ファイル選択**: .json ファイルの選択
2. **進行状況表示**: インポート中のローディング表示
3. **結果表示**: 成功・警告・エラーの詳細表示

#### アクセスポイント
- コード譜表示画面の「エクスポート」ボタン（個別エクスポート）
- コード譜表示画面の「インポート・エクスポート」ボタン（詳細機能）

### バリデーションとエラーハンドリング

#### 検証項目
- 必須フィールドの存在確認（id, title, key, timeSignature, sections）
- 日付フィールドの有効性チェック
- セクション構造の整合性確認
- 拍子と拍数の整合性チェック

#### 自動修正機能
- 不正日付 → 現在時刻に設定
- 未定義セクションID → 自動生成
- 拍子不整合 → 拍子から拍数を再計算
- 不足プロパティ → デフォルト値で補完

### テスト結果
- **総テスト数**: 98個（14個の新規テスト追加）
- **テスト成功率**: 100%
- **ESLintエラー**: 0個
- **TypeScriptエラー**: 0個

#### エクスポート・インポートテスト内容
1. エクスポート機能（単一・複数・全楽譜）
2. ファイル名サニタイズ
3. 有効データの解析
4. 旧フォーマット対応
5. 単一コード譜対応
6. 不正JSON処理
7. 必須フィールドチェック
8. 日付修正機能
9. セクションプロパティ補完
10. バージョン違い対応
11. 拍子対応処理

### パフォーマンス最適化
- **大容量データ対応**: Blob APIを使用した効率的なファイル生成
- **メモリ管理**: URL.revokeObjectURL() による適切なクリーンアップ
- **エラー回復**: 部分的な失敗でも可能な限りデータを復旧

### セキュリティ対策
- **ファイル名サニタイズ**: 悪意のあるファイル名の無害化
- **入力検証**: 不正なJSONデータからの保護
- **型安全性**: TypeScriptによる厳密な型チェック

## 学習・改善点
- ファイル操作のブラウザAPI（Blob, URL, FileReader）の活用
- 包括的なデータバリデーション設計の重要性
- 下位互換性を保ちながらの機能拡張手法
- ユーザーフレンドリーなエラーメッセージの設計

## 今後の拡張可能性
- PDF/テキスト形式でのエクスポート
- クラウドストレージとの連携
- QRコードによる楽譜共有
- 楽譜の暗号化機能