# TODO

> 📝 **注意**: 完了済みのタスクは [TODO_DONE.md](./TODO_DONE.md) に移動されました。

## 次期実装予定の機能

### 最優先機能: Google Drive同期
- [x] **複数環境でのスコア同期機能** (推定工数: 2-3週間)
  - [x] 基盤層実装
    - [x] Google API Console設定 (プロジェクト作成、OAuth 2.0設定) ※.env.exampleファイル作成済み
    - [x] 認証フロー実装 (GoogleAuthProvider、トークン管理)
    - [x] 同期アダプター層 (ISyncAdapter、GoogleDriveSyncAdapter)
  - [x] 同期ロジック実装
    - [x] タイムスタンプ管理 (lastSyncedAt、lastModifiedAt、deviceId)
    - [x] コンフリクト検出 (後勝ち戦略、警告表示)
    - [x] 同期実行フロー (pull → compare → warn → push)
  - [x] UI/UX実装
    - [x] 同期状態表示 (SyncStatusIndicator、最終同期時刻)
    - [x] コンフリクト警告ダイアログ (上書き前プレビュー、バックアップオプション)
    - [x] 設定画面 (同期有効/無効、アカウント連携状態、手動同期)
  - [x] エラーハンドリング・テスト
    - [x] ネットワーク/認証エラー対応、リトライ機構
    - [x] MockSyncAdapter実装、コンフリクトシナリオテスト
  - [x] ストア統合・実装完了
    - [x] ~~chordChartStoreへの同期機能統合~~ → **ストア分離対応済み** (PR#88)
      - [x] chordChartStore分離 (396行→256行)
      - [x] syncStore新規作成 (132行、19テスト)
      - [x] 責務分離による保守性向上
    - [x] **ストア間連携実装** (2024-12-16完了)
      - [x] SyncResult型にmergedChartsフィールド追加
      - [x] chordChartStoreにapplySyncedCharts()とイベント機能追加
      - [x] SyncManagerでmergedCharts返却対応
      - [x] useChartSyncカスタムフック作成（手動+自動同期）
    - [x] **残り実装タスク** 
      - [x] Header/MainLayoutへの同期UI追加  
      - [x] App.tsxでの同期初期化処理
      - [x] 初回認証フロー実装
      - [x] Google Drive API認証エラーの修正（フォルダ作成処理）

### 最優先：E2Eテスト基盤構築
- [ ] **E2Eテスト基盤構築** (推定工数: 1-2週間)
  - **理由**: 同期機能の複雑性を考慮し、安全な開発・リファクタリングのため品質保証基盤を先に構築
  - **効果**: 削除同期バグ等の回帰防止、起動時同期等の新機能開発時の品質担保
  - [ ] Phase 1: Playwright環境構築
    - [ ] `@playwright/test` パッケージインストール
    - [ ] `playwright.config.ts` 設定ファイル作成
    - [ ] ディレクトリ構造構築 (e2e/tests/, e2e/fixtures/, e2e/pages/, e2e/utils/)
    - [ ] package.json スクリプト追加 (`test:e2e`, `test:e2e:ui`)
  - [ ] Phase 2: データテストID追加
    - [ ] 重要UI要素への `data-testid` 属性付与
    - [ ] ボタン、フォーム、ナビゲーション要素の識別子設定
    - [ ] Page Object Model パターンの実装
  - [ ] Phase 3: コア機能E2Eテスト実装（自動テスト対象）
    - [ ] チャート作成→編集→保存→表示フロー
    - [ ] セクション追加→コード入力→ドラッグ&ドロップ並び替え
    - [ ] 移調機能の完全動作テスト（全キー対応）
    - [ ] LocalForage永続化とセッション復帰テスト
    - [ ] インポート/エクスポート完全フロー
  - [ ] Phase 4: PWA機能E2Eテスト（自動テスト対象）
    - [ ] オフライン動作テスト（ネットワーク切断時）
    - [ ] Service Worker動作確認
    - [ ] PWAインストールプロンプト・ホーム画面追加テスト
    - [ ] アプリアップデート処理テスト
    - [ ] モバイル操作（タップ、スワイプ、レスポンシブ）
  - [ ] Phase 5: CI/CD統合
    - [ ] GitHub Actions での E2E テスト自動実行
    - [ ] Pull Request での E2E テスト必須化
    - [ ] テスト結果レポート生成

### 手動テスト項目（Google Drive同期系）
- [ ] **同期機能手動テストプロセス確立** (推定工数: 1日)
  - **理由**: OAuth認証・実Google Driveアカウントが必要なため自動化困難
  - **範囲**: 認証フロー、削除同期、起動時同期、コンフリクト処理
  - [ ] 手動テストチェックリスト作成
    - [ ] 基本同期フロー（認証→手動同期→データ確認）
    - [ ] **削除同期テスト**（デバイス間削除の正常動作確認）
    - [ ] コンフリクト処理テスト（複数デバイス同時編集）
    - [ ] **起動時同期テスト**（将来実装時の検証用）
    - [ ] ネットワークエラー・認証エラー処理確認
  - [ ] テスト環境・手順ドキュメント作成
  - [ ] 新機能リリース前の手動テスト実施プロセス確立

### 高優先度（E2Eテスト完成後に実装）

#### Google Drive同期の問題修正
- [ ] **削除操作の同期修正** (推定工数: 2-3日)
  - **背景**: 現在の同期実装では楽譜削除が正しく同期されない重要なバグが存在
  - **問題**: SyncManager.mergeCharts()で削除されたチャートがリモートから復活してしまう
  - **原因**: 削除されたチャートはlocalCharts配列に含まれないため、リモートの古いデータがマージ時に残存
  - [ ] Phase 1: 削除追跡システム実装
    - [ ] 削除されたチャートIDをローカルストレージで記録する仕組み追加
    - [ ] deletedChartIds配列をSyncManagerの同期処理に統合
    - [ ] ChartCrudStoreの削除メソッドで削除記録を更新
  - [ ] Phase 2: 同期ロジック修正
    - [ ] SyncManager.sync()で削除リストも含めて処理するよう修正
    - [ ] mergeCharts()で削除されたチャートを除外するロジック追加
    - [ ] GoogleDriveSyncAdapterで削除情報の永続化対応
  - [ ] Phase 3: テスト・検証
    - [ ] 削除同期のE2Eテスト実装（デバイス間削除検証）
    - [ ] 削除コンフリクト処理のテスト追加
    - [ ] 実機での削除同期動作確認

#### Google Drive同期機能の公開準備
- [ ] **同期機能のユーザー公開** (推定工数: 30分)
  - **前提条件**: E2Eテスト基盤構築、削除同期修正、手動テストプロセス確立がすべて完了済み
  - **内容**: フィーチャーフラグ（隠しコマンド）を外して同期機能を一般ユーザーに公開
  - **変更ファイル**: `src/hooks/useHiddenFeatures.ts` の `syncSettings` を `true` に変更
  - **影響**: ヘッダーの同期ステータスインジケータと同期設定ボタンが全ユーザーに表示される
  - **注意**: 必ず上記3つの前提条件完了後に実施すること（データ安全性確保のため）

#### Google Drive同期の改善
- [ ] **起動時自動同期の実装** (推定工数: 1-2日)
  - **背景**: ユーザビリティ向上のため、アプリ起動時に自動で最新データを同期したい
  - **現状**: useChartSyncで初期化は行うが、起動時の自動同期は実装されていない
  - **効果**: 別デバイスでの作業後にアプリを開いた時、手動同期不要で最新データが表示される
  - [ ] Phase 1: 現状分析・設計
    - [ ] useChartSyncの初期化フローを分析
    - [ ] App.tsxでの起動シーケンスとタイミング調査
    - [ ] 起動時同期の実行条件を定義（認証済み、自動同期有効、ネットワーク接続）
  - [ ] Phase 2: 起動時同期ロジック実装
    - [ ] useChartSyncに起動時同期フラグとロジック追加
    - [ ] 初期データロード完了後の自動同期トリガー実装
    - [ ] 同期中の重複実行防止機能
  - [ ] Phase 3: UX改善
    - [ ] 起動時同期中のローディング表示（ヘッダー等）
    - [ ] 同期完了・失敗時の適切な通知
    - [ ] オフライン時・認証切れ時の適切な処理
    - [ ] 起動時同期の設定ON/OFF機能追加

- [ ] **アクセストークンの自動リフレッシュ機能実装** (推定工数: 3-5日)
  - **背景**: 現在のImplicit Flow実装では1時間ごとに再認証が必要でUX悪化
  - **課題**: リフレッシュトークンが取得できず、自動同期が頻繁に停止
  - [ ] Phase 1: Authorization Code Flow + PKCE実装
    - [ ] 現在のImplicit FlowからAuthorization Code Flow + PKCEに変更
    - [ ] リフレッシュトークンの取得・永続化機能実装
    - [ ] PKCEパラメータ生成・検証処理実装
  - [ ] Phase 2: 自動トークンリフレッシュ機能
    - [ ] `refreshAccessToken()`メソッド実装（/oauth2/tokenエンドポイント呼び出し）
    - [ ] `getValidAccessToken()`で期限チェック＆自動更新機能
    - [ ] トークン有効期限管理機能（expiryTime追跡）
  - [ ] Phase 3: API呼び出し統一化
    - [ ] `authenticatedFetch()`ラッパー実装（401エラー時自動リトライ）
    - [ ] GoogleDriveSyncAdapterでの統一API呼び出し
    - [ ] エラーハンドリング強化（認証エラー時の再認証フロー）
  - [ ] Phase 4: ユーザー体験改善
    - [ ] 長期間利用可能な認証状態（リフレッシュトークンで最大6ヶ月）
    - [ ] 自動同期の信頼性向上（トークン切れによる同期停止を解消）
    - [ ] 認証エラー時のユーザーフレンドリーなメッセージ表示

- [ ] exportするときにjsonがインデントされていて、ヒューマンリーダブルではあるんだけど無駄なので余計な空白はなしにしてほしいな

### 中優先度

#### バンド・グループ機能
- [ ] **楽譜共有リンク機能** (推定工数: 3-4日)
  - **背景**: バンドメンバー間での楽譜共有を簡単にしたい（LINEやメール等で手軽に送信）
  - **ユースケース**: 練習前に楽譜を事前共有、ライブ当日の急な楽譜追加、リモート練習での楽譜統一
  - **技術方針**: Google Drive公開共有方式（既存同期インフラ活用、バックエンドレス維持）
  - [ ] Phase 1: 共有機能基盤実装
    - [ ] GoogleDriveSyncAdapter拡張（公開ファイルアップロード対応）
    - [ ] 楽譜共有専用フォルダ管理機能
    - [ ] 既存export機能をベースにした公開ファイル生成
    - [ ] 共有URL生成機能（クエリストリングでファイルID埋め込み）
  - [ ] Phase 2: 共有側UI実装
    - [ ] Score Explorerに「楽譜を共有」ボタン追加
    - [ ] 共有リンク生成ダイアログ（URL表示・コピー機能）
    - [ ] 共有状況表示（アップロード中・完了・エラー）
    - [ ] 共有した楽譜の管理画面（削除・再共有）
  - [ ] Phase 3: 受け取り側実装
    - [ ] 共有URLのクエリストリング解析機能
    - [ ] Google Drive公開ファイル取得（認証不要）
    - [ ] インポート確認ダイアログ（楽譜プレビュー付き）
    - [ ] 自動インポート処理（既存import機能活用）
  - [ ] Phase 4: エラーハンドリング・UX改善
    - [ ] 共有ファイル削除時の適切なエラー表示
    - [ ] ネットワークエラー・APIクォータ対応
    - [ ] 意図しない公開防止機能（確認ダイアログ）
    - [ ] 共有リンクの有効期限表示

#### その他機能
- [ ] モバイル環境で使っている時に、インプットにフォーカスされたりするとそこにズームインしてしまう。常に同じサイズで使いたい
- [ ] リロードすると、開いていた楽譜ファイルとは違う楽譜ファイルが開いた状態になる。最後に開いていた譜面を覚えていてほしい。
- [ ] Score Explorerの楽譜一覧のソート機能を作りたい(名前、作成日時、更新日時それぞれに対して昇順、降順)
- [ ] コード譜の検索・フィルタリング機能
- [ ] PWAアイコンの作成・設定
- [ ] エクスポート機能（PDF、テキスト等）
- [ ] コード譜のバックアップ・復元機能

### 低優先度
- [ ] オフライン対応の詳細実装
- [ ] ダークモード対応
- [ ] 楽器別表示設定

---

## 📈 進捗状況

- **完了済みタスク**: [TODO_DONE.md](./TODO_DONE.md) を参照
- **現在のタスク数**: 5件
- **最優先度**: E2Eテスト導入（PWA品質保証の観点から最重要）
- **同期機能進捗**: ✅ 実装完了

### 🎯 現在の状況（2025-06-17時点）
- ✅ **PR#88**: chordChartStore分離完了（ストア責務分離）
- ✅ **PR#89**: syncStore-chordChartStore連携実装完了
- ✅ **PR#102**: Google Drive同期UI統合完了
- ✅ **chordChartStoreリファクタリング**: 338行ストアを3ストアに分離（chartDataStore、chartCrudStore、useChartManagement統合フック）
- ✅ **Google Drive同期機能実装完了**: 認証エラー修正（フォルダ自動作成処理）
- 📋 **進捗**: 同期機能の全実装完了（基盤・ロジック・ストア連携・UI統合・エラーハンドリング）