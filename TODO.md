# TODO

> 📝 **運用ルール**: 
> - 完了したタスクは即座に [TODO_DONE.md](./TODO_DONE.md) に移動する
> - タスクを完了したらすぐに該当行を削除してTODO_DONE.mdに追記する

## 次期実装予定の機能


### 最優先：E2Eテスト強化（緊急対応必要）

#### ✅ **Phase 1完了状況（2025-06-18更新）**
**現在のE2Eテスト評価: B評価（大幅改善達成）**
- **コア機能カバレッジ**: 80% - 音楽アプリの核心機能検証完了
- **音楽理論機能検証**: 90% - 移調機能の完全検証完了
- **データ永続化検証**: 60% - 移調後の永続化・復元検証完了
- **品質保証レベル**: 高 - 音楽機能の回帰バグ検出能力確保

**🔍 Phase 1達成内容:**
- ✅ **基盤は構築済み**: Playwright環境、Page Object Model、data-testid付与完了
- ✅ **コア機能検証完了**: 移調(100%)、D&D(100%)、実際のコード編集(100%)
- ❌ **残Phase 2課題**: インポート/エクスポート(0%)、完全永続化テスト、PWA機能
- ✅ **品質問題解決**: E2Eテストフラグ適切設定、編集モード読み込み待機処理

- [ ] **E2Eテスト緊急強化** (推定工数: 1-2週間)
  - **理由**: 
    - 既存テストは「フォーム操作の表面確認」のみで音楽アプリとしてのコア機能が未検証
    - 削除同期バグ等の重要問題がE2Eで検出できない致命的状況
    - リファクタリング・新機能開発時の安全性が著しく不足
  - **効果**: 削除同期バグ等の回帰防止、音楽機能の品質保証、開発安全性向上

  - [x] **Phase 1: 緊急コア機能テスト実装** ⚡ ✅ 完了（2025-06-18）
    - [x] **移調機能の完全テスト** - ✅ 実装完了（2025-06-18）
      - [x] チャート作成(Cキー) → コード入力(C-Am-F-G) → G移調実行 → コード確認(G-Em-C-D)
      - [x] 複数キー移調テスト(C→G→D→A→E) → 全コード正確性検証
      - [x] 移調後の表示・保存・復元の完全フロー
    - [x] **実際のコード編集テスト** - ✅ 実装完了（2025-06-18）
      - [x] セクション追加(Aメロ、Bメロ、サビ) → セクション順序確認
      - [x] コード入力・編集(C, Am, F, G, Dm等) → 入力結果検証
      - [x] セクション・コード削除機能、メモ機能の完全テスト
    - [x] **ドラッグ&ドロップ操作テスト** - ✅ 実装完了（2025-06-18）
      - [x] コード順序変更(C-Am-F-G → Am-C-G-F) → 順序確認
      - [x] セクション順序変更(イントロ-Aメロ-Bメロ → Aメロ-イントロ-Bメロ)
      - [x] 複雑なD&D操作の組み合わせテスト

  - [ ] **Phase 2: データ永続化・フロー強化** (高優先度 - 2週間以内)
    - [ ] **LocalForage永続化の完全テスト**
      - [ ] 複雑チャート作成 → ページリロード → データ完全復元確認
      - [ ] セッション継続性・データ整合性の詳細検証
      - [ ] 大量データ・複数チャートでの永続化テスト
    - [ ] **インポート・エクスポート機能テスト** - 現在0%カバレッジ
      - [ ] JSONエクスポート → ファイル内容検証 → 新セッション → インポート → データ一致確認
      - [ ] エラーハンドリング(不正JSON、バージョン不整合等)
      - [ ] 大容量ファイル・特殊文字対応テスト
    - [ ] **テスト品質改善**
      - [x] テストデータクリーンアップ実装(各テスト前後でLocalStorage初期化) - ✅ 完了
      - [ ] ハードコード待機(waitFor(2000))をwaitFor条件ベースに変更
      - [ ] エラーハンドリングテスト追加(ネットワークエラー、バリデーションエラー等)

  - [ ] **Phase 3: PWA・モバイル対応テスト** (中優先度 - 1ヶ月以内)
    - [ ] **PWAオフライン機能テスト** - 現在0%カバレッジ
      - [ ] オンライン状態でチャート作成 → ネットワーク切断 → オフライン編集確認
      - [ ] ネットワーク復帰 → データ整合性・同期確認
      - [ ] Service Worker動作・キャッシュ戦略検証
    - [ ] **レスポンシブ・モバイル対応詳細テスト**
      - [ ] デスクトップ↔モバイルビューポート切り替え → データ保持確認
      - [ ] モバイル特有操作(タップ、スワイプ、ピンチ) → 操作性検証
      - [ ] タッチデバイスでのD&D操作・フォーム入力テスト

  - [ ] **Phase 4: CI/CD統合・継続的品質保証** (Phase 1-2完了後)
    - [ ] GitHub Actions での E2E テスト自動実行
    - [ ] Pull Request での E2E テスト必須化
    - [ ] テスト結果レポート生成・失敗時の詳細情報取得

### 手動テスト項目（Google Drive同期系）
- [ ] **同期機能手動テストプロセス確立** (推定工数: 1日)
  - **理由**: OAuth認証・実Google Driveアカウントが必要なため自動化困難
  - **範囲**: 認証フロー、削除同期、起動時同期、コンフリクト処理
  - [ ] 手動テストチェックリスト作成
    - [ ] 基本同期フロー（認証→手動同期→データ確認）
    - [ ] **削除同期テスト**（デバイス間削除の正常動作確認）
    - [ ] コンフリクト処理テスト（複数デバイス同時編集）
    - [ ] **起動時同期テスト**（将来実装時の検証用）
    - [ ] ネットワークエラー・認証エラー処理確認
  - [ ] テスト環境・手順ドキュメント作成
  - [ ] 新機能リリース前の手動テスト実施プロセス確立

### 高優先度（E2Eテスト完成後に実装）

#### Google Drive同期の問題修正
- [ ] **削除操作の同期修正** (推定工数: 2-3日)
  - **背景**: 現在の同期実装では楽譜削除が正しく同期されない重要なバグが存在
  - **問題**: SyncManager.mergeCharts()で削除されたチャートがリモートから復活してしまう
  - **原因**: 削除されたチャートはlocalCharts配列に含まれないため、リモートの古いデータがマージ時に残存
  - [ ] Phase 1: 削除追跡システム実装
    - [ ] 削除されたチャートIDをローカルストレージで記録する仕組み追加
    - [ ] deletedChartIds配列をSyncManagerの同期処理に統合
    - [ ] ChartCrudStoreの削除メソッドで削除記録を更新
  - [ ] Phase 2: 同期ロジック修正
    - [ ] SyncManager.sync()で削除リストも含めて処理するよう修正
    - [ ] mergeCharts()で削除されたチャートを除外するロジック追加
    - [ ] GoogleDriveSyncAdapterで削除情報の永続化対応
  - [ ] Phase 3: テスト・検証
    - [ ] 削除同期のE2Eテスト実装（デバイス間削除検証）
    - [ ] 削除コンフリクト処理のテスト追加
    - [ ] 実機での削除同期動作確認

#### Google Drive同期機能の公開準備
- [ ] **同期機能のユーザー公開** (推定工数: 30分)
  - **前提条件**: E2Eテスト基盤構築、削除同期修正、手動テストプロセス確立がすべて完了済み
  - **内容**: フィーチャーフラグ（隠しコマンド）を外して同期機能を一般ユーザーに公開
  - **変更ファイル**: `src/hooks/useHiddenFeatures.ts` の `syncSettings` を `true` に変更
  - **影響**: ヘッダーの同期ステータスインジケータと同期設定ボタンが全ユーザーに表示される
  - **注意**: 必ず上記3つの前提条件完了後に実施すること（データ安全性確保のため）

#### Google Drive同期の改善
- [ ] **起動時自動同期の実装** (推定工数: 1-2日)
  - **背景**: ユーザビリティ向上のため、アプリ起動時に自動で最新データを同期したい
  - **現状**: useChartSyncで初期化は行うが、起動時の自動同期は実装されていない
  - **効果**: 別デバイスでの作業後にアプリを開いた時、手動同期不要で最新データが表示される
  - [ ] Phase 1: 現状分析・設計
    - [ ] useChartSyncの初期化フローを分析
    - [ ] App.tsxでの起動シーケンスとタイミング調査
    - [ ] 起動時同期の実行条件を定義（認証済み、自動同期有効、ネットワーク接続）
  - [ ] Phase 2: 起動時同期ロジック実装
    - [ ] useChartSyncに起動時同期フラグとロジック追加
    - [ ] 初期データロード完了後の自動同期トリガー実装
    - [ ] 同期中の重複実行防止機能
  - [ ] Phase 3: UX改善
    - [ ] 起動時同期中のローディング表示（ヘッダー等）
    - [ ] 同期完了・失敗時の適切な通知
    - [ ] オフライン時・認証切れ時の適切な処理
    - [ ] 起動時同期の設定ON/OFF機能追加

- [ ] **アクセストークンの自動リフレッシュ機能実装** (推定工数: 3-5日)
  - **背景**: 現在のImplicit Flow実装では1時間ごとに再認証が必要でUX悪化
  - **課題**: リフレッシュトークンが取得できず、自動同期が頻繁に停止
  - [ ] Phase 1: Authorization Code Flow + PKCE実装
    - [ ] 現在のImplicit FlowからAuthorization Code Flow + PKCEに変更
    - [ ] リフレッシュトークンの取得・永続化機能実装
    - [ ] PKCEパラメータ生成・検証処理実装
  - [ ] Phase 2: 自動トークンリフレッシュ機能
    - [ ] `refreshAccessToken()`メソッド実装（/oauth2/tokenエンドポイント呼び出し）
    - [ ] `getValidAccessToken()`で期限チェック＆自動更新機能
    - [ ] トークン有効期限管理機能（expiryTime追跡）
  - [ ] Phase 3: API呼び出し統一化
    - [ ] `authenticatedFetch()`ラッパー実装（401エラー時自動リトライ）
    - [ ] GoogleDriveSyncAdapterでの統一API呼び出し
    - [ ] エラーハンドリング強化（認証エラー時の再認証フロー）
  - [ ] Phase 4: ユーザー体験改善
    - [ ] 長期間利用可能な認証状態（リフレッシュトークンで最大6ヶ月）
    - [ ] 自動同期の信頼性向上（トークン切れによる同期停止を解消）
    - [ ] 認証エラー時のユーザーフレンドリーなメッセージ表示

- [ ] exportするときにjsonがインデントされていて、ヒューマンリーダブルではあるんだけど無駄なので余計な空白はなしにしてほしいな

### 中優先度

#### バンド・グループ機能
- [ ] **楽譜共有リンク機能** (推定工数: 3-4日)
  - **背景**: バンドメンバー間での楽譜共有を簡単にしたい（LINEやメール等で手軽に送信）
  - **ユースケース**: 練習前に楽譜を事前共有、ライブ当日の急な楽譜追加、リモート練習での楽譜統一
  - **技術方針**: Google Drive公開共有方式（既存同期インフラ活用、バックエンドレス維持）
  - [ ] Phase 1: 共有機能基盤実装
    - [ ] GoogleDriveSyncAdapter拡張（公開ファイルアップロード対応）
    - [ ] 楽譜共有専用フォルダ管理機能
    - [ ] 既存export機能をベースにした公開ファイル生成
    - [ ] 共有URL生成機能（クエリストリングでファイルID埋め込み）
  - [ ] Phase 2: 共有側UI実装
    - [ ] Score Explorerに「楽譜を共有」ボタン追加
    - [ ] 共有リンク生成ダイアログ（URL表示・コピー機能）
    - [ ] 共有状況表示（アップロード中・完了・エラー）
    - [ ] 共有した楽譜の管理画面（削除・再共有）
  - [ ] Phase 3: 受け取り側実装
    - [ ] 共有URLのクエリストリング解析機能
    - [ ] Google Drive公開ファイル取得（認証不要）
    - [ ] インポート確認ダイアログ（楽譜プレビュー付き）
    - [ ] 自動インポート処理（既存import機能活用）
  - [ ] Phase 4: エラーハンドリング・UX改善
    - [ ] 共有ファイル削除時の適切なエラー表示
    - [ ] ネットワークエラー・APIクォータ対応
    - [ ] 意図しない公開防止機能（確認ダイアログ）
    - [ ] 共有リンクの有効期限表示

#### その他機能
- [ ] モバイル環境で使っている時に、インプットにフォーカスされたりするとそこにズームインしてしまう。常に同じサイズで使いたい
- [ ] リロードすると、開いていた楽譜ファイルとは違う楽譜ファイルが開いた状態になる。最後に開いていた譜面を覚えていてほしい。
- [ ] Score Explorerの楽譜一覧のソート機能を作りたい(名前、作成日時、更新日時それぞれに対して昇順、降順)
- [ ] コード譜の検索・フィルタリング機能
- [ ] PWAアイコンの作成・設定
- [ ] エクスポート機能（PDF、テキスト等）
- [ ] コード譜のバックアップ・復元機能

### 低優先度
- [ ] オフライン対応の詳細実装
- [ ] ダークモード対応
- [ ] 楽器別表示設定

---

## 📈 進捗状況

- **完了済みタスク**: [TODO_DONE.md](./TODO_DONE.md) を参照
- **現在のタスク数**: 5件
- **最優先度**: E2Eテスト導入（PWA品質保証の観点から最重要）
- **同期機能進捗**: ✅ 実装完了

### 🎯 現在の状況（2025-06-18時点）
- ✅ **Google Drive同期機能**: 全実装完了、TODO_DONE.mdに移動済み  
- ✅ **E2Eテスト基盤**: Playwright環境、Page Object Model、data-testid付与完了
- ✅ **Phase 1完了**: 音楽機能（移調、コード編集、D&D）のE2Eテスト実装完了
- 📋 **次優先事項**: Phase 2データ永続化・フロー強化、インポート/エクスポート機能テスト

### 📊 E2Eテスト現状評価（Phase 1完了後）
- **基盤構築**: ✅ 完了（Playwright、Page Object、data-testid）
- **UI操作テスト**: ✅ 基本完了（フォーム操作、画面遷移）
- **音楽機能テスト**: ✅ 実装完了（移調100%、コード編集100%、D&D100%）
- **データ永続化**: ⚠️ 部分的（移調後永続化完了、完全テスト残Phase 2）
- **PWA機能**: ❌ 未実装（オフライン0%、Service Worker0%）
- **総合評価**: B評価達成（音楽アプリとしての品質保証確保）